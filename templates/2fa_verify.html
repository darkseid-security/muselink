<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Two-Factor Authentication - MuseLink</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/auth.css">
</head>

<body>
    <div class="aurora-background">
        <div class="aurora-dot"></div>
        <div class="aurora-dot"></div>
        <div class="aurora-dot"></div>
    </div>

    <div class="auth-page-wrapper">
        <div class="auth-container">
            <div class="auth-visual-panel">
                <div class="visual-orb-container">
                    <div id="auth-orb"></div>
                </div>
            </div>

            <div class="auth-form-panel">
                <!-- Flash Messages -->
                <div id="flash-container" style="margin-bottom: 1rem;"></div>

                <!-- 2FA Verification Form -->
                <div class="auth-card is-active" id="2fa-card">
                    <div class="auth-header">
                        <a href="/" class="logo">MuseLink</a>
                        <h1>Two-Factor Authentication</h1>
                        <p>Enter the 6-digit code from your authenticator app.</p>
                    </div>

                    <form class="auth-form" id="2fa-form">
                        <div class="form-group">
                            <label for="mfa-code">Authentication Code</label>
                            <div class="input-wrapper">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                                    class="input-icon">
                                    <path fill-rule="evenodd"
                                        d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z"
                                        clip-rule="evenodd" />
                                </svg>
                                <input
                                    type="text"
                                    id="mfa-code"
                                    name="mfa_code"
                                    placeholder="000000"
                                    required
                                    maxlength="6"
                                    pattern="[0-9]{6}"
                                    autocomplete="off"
                                    inputmode="numeric"
                                    autofocus>
                            </div>
                            <small style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.5rem; display: block;">
                                Open your authenticator app (Google Authenticator, Authy, etc.) and enter the 6-digit code.
                            </small>
                        </div>

                        <button type="submit" class="btn btn-primary btn-full">Verify Code</button>
                    </form>

                    <div class="auth-footer">
                        <p><a href="/auth" class="auth-link">‚Üê Back to Login</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Flash message system
            function showFlashMessage(message, type = 'error') {
                const flashContainer = document.getElementById('flash-container');
                if (!flashContainer) return;

                // Create flash message element
                const flashDiv = document.createElement('div');
                flashDiv.className = `flash-message flash-${type}`;
                flashDiv.style.cssText = `
                    padding: 1rem;
                    margin-bottom: 1rem;
                    border-radius: 8px;
                    font-size: 0.9rem;
                    animation: slideIn 0.3s ease-out;
                `;

                if (type === 'error') {
                    flashDiv.style.backgroundColor = 'rgba(239, 68, 68, 0.1)';
                    flashDiv.style.border = '1px solid rgba(239, 68, 68, 0.3)';
                    flashDiv.style.color = '#ef4444';
                } else if (type === 'success') {
                    flashDiv.style.backgroundColor = 'rgba(34, 197, 94, 0.1)';
                    flashDiv.style.border = '1px solid rgba(34, 197, 94, 0.3)';
                    flashDiv.style.color = '#22c55e';
                } else if (type === 'warning') {
                    flashDiv.style.backgroundColor = 'rgba(251, 191, 36, 0.1)';
                    flashDiv.style.border = '1px solid rgba(251, 191, 36, 0.3)';
                    flashDiv.style.color = '#fbbf24';
                }

                flashDiv.textContent = message;

                // Clear existing messages
                flashContainer.innerHTML = '';
                flashContainer.appendChild(flashDiv);

                // Auto-remove after 5 seconds
                setTimeout(() => {
                    flashDiv.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => flashDiv.remove(), 300);
                }, 5000);
            }

            // Add CSS animations
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from {
                        opacity: 0;
                        transform: translateY(-10px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
                @keyframes slideOut {
                    from {
                        opacity: 1;
                        transform: translateY(0);
                    }
                    to {
                        opacity: 0;
                        transform: translateY(-10px);
                    }
                }
            `;
            document.head.appendChild(style);

            // Orb Animation Generator
            const orb = document.getElementById('auth-orb');
            if (orb) {
                const rings = 12;
                for (let i = 0; i < rings; i++) {
                    const ring = document.createElement('div');
                    ring.className = 'orb-ring';
                    const angle = (i / rings) * 180;
                    const color = `color-mix(in srgb, var(--accent-start) ${100 - i * 6}%, var(--accent-end))`;
                    ring.style.transform = `rotateY(${angle}deg) scale(${1 - Math.sin(angle * Math.PI / 180) * 0.2})`;
                    ring.style.borderColor = color;
                    orb.appendChild(ring);
                }
            }

            // SECURE: Session token is stored in HTTP-only cookie (set by server)
            // JavaScript CANNOT access it - this prevents XSS attacks
            // We simply check if the user was redirected from login page

            // Handle 2FA form submission
            const mfaForm = document.getElementById('2fa-form');
            if (mfaForm) {
                mfaForm.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    const mfaCode = document.getElementById('mfa-code').value.trim();

                    // Validate code format
                    if (!/^\d{6}$/.test(mfaCode)) {
                        showFlashMessage('Please enter a valid 6-digit code.', 'error');
                        return;
                    }

                    try {
                        // SECURE: Session token sent automatically via HTTP-only cookie
                        // No need to include it in request body
                        const response = await fetch('/auth/mfa/verify', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'include',  // Include cookies in request
                            body: JSON.stringify({
                                mfa_code: mfaCode
                            })
                        });

                        const result = await response.json();

                        if (response.ok) {
                            // SECURE: Permanent session cookie is set automatically by server
                            // Temporary MFA cookie is cleared by server
                            // No client-side token management needed

                            // Silent redirect on success (no flash message)
                            setTimeout(() => {
                                window.location.href = '/dashboard';
                            }, 500);
                        } else {
                            // Handle validation errors
                            let errorMsg = result.error || result.detail || 'Invalid authentication code.';

                            if (errorMsg.includes('Invalid authenticator code')) {
                                errorMsg = 'Invalid code. Please check your authenticator app and try again.';
                            } else if (errorMsg.includes('Session expired') || errorMsg.includes('Session validation failed') || errorMsg.includes('MFA session not found')) {
                                errorMsg = 'Session expired or invalid. Please login again.';
                                setTimeout(() => {
                                    window.location.href = '/auth';
                                }, 2000);
                            }

                            showFlashMessage(errorMsg, 'error');
                        }
                    } catch (error) {
                        console.error('2FA verification error:', error);
                        showFlashMessage('An error occurred during verification. Please try again.', 'error');
                    }
                });
            }

            // Auto-format MFA code input (add hyphens for readability - optional)
            const mfaInput = document.getElementById('mfa-code');
            if (mfaInput) {
                mfaInput.addEventListener('input', function(e) {
                    // Remove non-numeric characters
                    let value = e.target.value.replace(/\D/g, '');

                    // Limit to 6 digits
                    if (value.length > 6) {
                        value = value.substring(0, 6);
                    }

                    e.target.value = value;
                });

                // Auto-submit when 6 digits are entered (optional - for better UX)
                mfaInput.addEventListener('input', function(e) {
                    if (e.target.value.length === 6) {
                        // Optional: Auto-submit after a short delay
                        // setTimeout(() => {
                        //     mfaForm.dispatchEvent(new Event('submit'));
                        // }, 500);
                    }
                });
            }
        });
    </script>

</body>

</html>
